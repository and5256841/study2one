generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  STUDENT
  COORDINATOR
  CLIENT
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PhotoType {
  CUADERNILLO
  MIND_MAP
  NOTES
  OTHER
}

enum EmailType {
  WELCOME
  WEEKLY_REPORT
  FEEDBACK
  INACTIVITY_ALERT
  SIMULACRO_REMINDER
  CERTIFICATE
}

enum EmailStatus {
  SENT
  FAILED
  BOUNCED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum NotificationType {
  REMINDER
  STREAK
  ACHIEVEMENT
  ANNOUNCEMENT
  SIMULACRO
  COORDINATOR_MESSAGE
}

enum MonthlyExamMode {
  WEEKLY
  CONTINUOUS
}

enum ExamSectionStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
}

enum ExamAnswerEventType {
  SELECTED
  CHANGED
  CLEARED
}

// ============ USERS & AUTH ============

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  passwordHash     String?          @map("password_hash")
  role             Role             @default(STUDENT)
  fullName         String           @map("full_name")
  documentId       String?          @map("document_id")
  pseudonym        String?
  avatarSeed       String?          @map("avatar_seed")
  avatarStyle      String?          @map("avatar_style")
  phone            String?
  university       String?
  isActive         Boolean          @default(true) @map("is_active")
  enrollmentStatus EnrollmentStatus @default(PENDING) @map("enrollment_status")
  enrolledAt       DateTime?        @map("enrolled_at")
  approvedAt       DateTime?        @map("approved_at")
  approvedById     String?          @map("approved_by_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  enrolledById     String?          @map("enrolled_by_id")
  approvedBy       User?            @relation("ApprovalRelation", fields: [approvedById], references: [id])
  approvedUsers    User[]           @relation("ApprovalRelation")
  enrolledBy       User?            @relation("EnrolledBy", fields: [enrolledById], references: [id])
  enrolledUsers    User[]           @relation("EnrolledBy")

  cohortStudents   CohortStudent[]
  coordinatedCohorts Cohort[]       @relation("CoordinatorCohorts")
  clientCohorts    Cohort[]         @relation("ClientCohorts")

  audioProgress      AudioProgress[]
  quizAttempts       QuizAttempt[]
  photoUploads       PhotoUpload[]
  writingSubmissions WritingSubmission[]
  streak             Streak?
  simulacroAttempts SimulacroAttempt[]
  announcements    Announcement[]
  emailLogs        EmailLog[]
  pushSubscriptions PushSubscription[]
  notifications    Notification[]
  certificates     Certificate[]
  createdSimulacros Simulacro[]
  monthlyExamAttempts MonthlyExamAttempt[]
  approvedPhotos   PhotoUpload[]    @relation("ApprovedPhotos")
  sentNotifications Notification[]  @relation("SentNotifications")
  manualUnlocks    ManualUnlock[]   @relation("ManualUnlocks")
  unlockedByMe     ManualUnlock[]   @relation("UnlockedByMe")
  scheduledExams   CohortExamSchedule[] @relation("ScheduledExams")

  @@map("users")
}

// ============ COHORTS ============

model Cohort {
  id              String          @id @default(uuid())
  name            String
  startDate       DateTime        @map("start_date")
  endDate         DateTime?       @map("end_date")
  coordinatorId   String          @map("coordinator_id")
  clientId        String?         @map("client_id")
  enrollmentQrCode String?        @map("enrollment_qr_code")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")

  coordinator     User            @relation("CoordinatorCohorts", fields: [coordinatorId], references: [id])
  client          User?           @relation("ClientCohorts", fields: [clientId], references: [id])
  students        CohortStudent[]
  simulacros      Simulacro[]
  announcements   Announcement[]
  certificates    Certificate[]
  examSchedules   CohortExamSchedule[]

  @@map("cohorts")
}

model CohortStudent {
  cohortId  String   @map("cohort_id")
  studentId String   @map("student_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  cohort    Cohort   @relation(fields: [cohortId], references: [id])
  student   User     @relation(fields: [studentId], references: [id])

  @@id([cohortId, studentId])
  @@index([studentId])
  @@map("cohort_students")
}

// ============ CONTENT ============

model Module {
  id          String         @id @default(uuid())
  number      Int            @unique
  name        String
  slug        String         @unique
  description String?
  icon        String?
  totalDays   Int            @default(15) @map("total_days")
  orderIndex  Int            @map("order_index")

  blocks      Block[]
  dailyContent DailyContent[]
  simulacroQuestions SimulacroQuestion[]

  @@map("modules")
}

model Block {
  id        String         @id @default(uuid())
  moduleId  String         @map("module_id")
  number    Int
  name      String?
  daysStart Int            @map("days_start")
  daysEnd   Int            @map("days_end")

  module    Module         @relation(fields: [moduleId], references: [id])
  dailyContent DailyContent[]

  @@unique([moduleId, number])
  @@map("blocks")
}

model DailyContent {
  id                   String          @id @default(uuid())
  moduleId             String          @map("module_id")
  blockId              String          @map("block_id")
  dayNumber            Int             @map("day_number")
  title                String
  ttsText              String?         @map("tts_text")
  audioUrl             String?         @map("audio_url")
  audioDurationSeconds Int?            @map("audio_duration_seconds")
  summary              String?
  keyConcepts          Json?           @map("key_concepts")
  isExamDay            Boolean         @default(false) @map("is_exam_day")
  createdAt            DateTime        @default(now()) @map("created_at")

  module               Module          @relation(fields: [moduleId], references: [id])
  block                Block           @relation(fields: [blockId], references: [id])
  questions            DailyQuestion[]
  audioProgress        AudioProgress[]
  quizAttempts         QuizAttempt[]
  photoUploads         PhotoUpload[]
  writingSubmissions   WritingSubmission[]

  @@unique([moduleId, dayNumber])
  @@map("daily_content")
}

// ============ QUIZ ============

model DailyQuestion {
  id             String           @id @default(uuid())
  dailyContentId String           @map("daily_content_id")
  questionOrder  Int              @map("question_order")
  caseText       String?          @map("case_text")
  questionText   String           @map("question_text")
  explanation    String
  competency     String?
  difficulty     Difficulty       @default(MEDIUM)

  dailyContent   DailyContent     @relation(fields: [dailyContentId], references: [id])
  options        QuestionOption[]
  quizAnswers    QuizAnswer[]

  @@unique([dailyContentId, questionOrder])
  @@map("daily_questions")
}

model QuestionOption {
  id         String       @id @default(uuid())
  questionId String       @map("question_id")
  letter     String
  text       String
  isCorrect  Boolean      @default(false) @map("is_correct")

  question   DailyQuestion @relation(fields: [questionId], references: [id])
  quizAnswers QuizAnswer[]

  @@map("question_options")
}

// ============ STUDENT PROGRESS ============

model AudioProgress {
  id                    String       @id @default(uuid())
  studentId             String       @map("student_id")
  dailyContentId        String       @map("daily_content_id")
  startedAt             DateTime?    @map("started_at")
  completedAt           DateTime?    @map("completed_at")
  lastPositionSeconds   Int          @default(0) @map("last_position_seconds")
  totalListenedSeconds  Int          @default(0) @map("total_listened_seconds")
  playbackSpeed         Float        @default(1.0) @map("playback_speed")
  isCompleted           Boolean      @default(false) @map("is_completed")
  completionPercentage  Float        @default(0) @map("completion_percentage")

  student               User         @relation(fields: [studentId], references: [id])
  dailyContent          DailyContent @relation(fields: [dailyContentId], references: [id])

  @@unique([studentId, dailyContentId])
  @@map("audio_progress")
}

model QuizAttempt {
  id             String       @id @default(uuid())
  studentId      String       @map("student_id")
  dailyContentId String       @map("daily_content_id")
  startedAt      DateTime     @default(now()) @map("started_at")
  completedAt    DateTime?    @map("completed_at")
  score            Int          @default(0)
  totalQuestions   Int          @default(3) @map("total_questions")
  timeSpentSeconds Int?         @map("time_spent_seconds")

  student        User         @relation(fields: [studentId], references: [id])
  dailyContent   DailyContent @relation(fields: [dailyContentId], references: [id])
  answers        QuizAnswer[]

  @@index([studentId])
  @@index([studentId, dailyContentId])
  @@map("quiz_attempts")
}

model QuizAnswer {
  attemptId        String         @map("attempt_id")
  questionId       String         @map("question_id")
  selectedOptionId String?        @map("selected_option_id")
  isCorrect        Boolean        @default(false) @map("is_correct")
  answeredAt       DateTime       @default(now()) @map("answered_at")

  attempt          QuizAttempt    @relation(fields: [attemptId], references: [id])
  question         DailyQuestion  @relation(fields: [questionId], references: [id])
  selectedOption   QuestionOption? @relation(fields: [selectedOptionId], references: [id])

  @@id([attemptId, questionId])
  @@map("quiz_answers")
}

model PhotoUpload {
  id             String       @id @default(uuid())
  studentId      String       @map("student_id")
  dailyContentId String       @map("daily_content_id")
  photoUrl       String?      @map("photo_url")
  thumbnailUrl   String?      @map("thumbnail_url")
  photoType      PhotoType    @default(OTHER) @map("photo_type")
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")
  isApproved     Boolean      @default(false) @map("is_approved")
  approvedAt     DateTime?    @map("approved_at")
  approvedById   String?      @map("approved_by_id")

  student        User         @relation(fields: [studentId], references: [id])
  dailyContent   DailyContent @relation(fields: [dailyContentId], references: [id])
  approvedBy     User?        @relation("ApprovedPhotos", fields: [approvedById], references: [id])

  @@index([studentId, dailyContentId])
  @@map("photo_uploads")
}

model WritingSubmission {
  id               String       @id @default(uuid())
  studentId        String       @map("student_id")
  dailyContentId   String       @map("daily_content_id")
  content          String
  wordCount        Int          @map("word_count")
  timeSpentSeconds Int?         @map("time_spent_seconds")
  submittedAt      DateTime     @default(now()) @map("submitted_at")

  student          User         @relation(fields: [studentId], references: [id])
  dailyContent     DailyContent @relation(fields: [dailyContentId], references: [id])

  @@index([studentId, dailyContentId])
  @@map("writing_submissions")
}

model Streak {
  id               String   @id @default(uuid())
  studentId        String   @unique @map("student_id")
  currentStreak    Int      @default(0) @map("current_streak")
  longestStreak    Int      @default(0) @map("longest_streak")
  lastActivityDate DateTime? @map("last_activity_date")
  updatedAt        DateTime @updatedAt @map("updated_at")

  student          User     @relation(fields: [studentId], references: [id])

  @@map("streaks")
}

// ============ SIMULACROS ============

model Simulacro {
  id              String             @id @default(uuid())
  cohortId        String             @map("cohort_id")
  title           String
  scheduledDate   DateTime           @map("scheduled_date")
  durationMinutes Int                @default(75) @map("duration_minutes")
  totalQuestions  Int                @default(50) @map("total_questions")
  isActive        Boolean            @default(false) @map("is_active")
  createdById     String             @map("created_by_id")
  createdAt       DateTime           @default(now()) @map("created_at")

  cohort          Cohort             @relation(fields: [cohortId], references: [id])
  createdBy       User               @relation(fields: [createdById], references: [id])
  questions       SimulacroQuestion[]
  attempts        SimulacroAttempt[]

  @@map("simulacros")
}

model SimulacroQuestion {
  id            String            @id @default(uuid())
  simulacroId   String            @map("simulacro_id")
  questionOrder Int               @map("question_order")
  caseText      String?           @map("case_text")
  questionText  String            @map("question_text")
  explanation   String?
  competency    String?
  moduleId      String?           @map("module_id")

  simulacro     Simulacro         @relation(fields: [simulacroId], references: [id])
  module        Module?           @relation(fields: [moduleId], references: [id])
  options       SimulacroOption[]
  answers       SimulacroAnswer[]

  @@map("simulacro_questions")
}

model SimulacroOption {
  id         String            @id @default(uuid())
  questionId String            @map("question_id")
  letter     String
  text       String
  isCorrect  Boolean           @default(false) @map("is_correct")

  question   SimulacroQuestion @relation(fields: [questionId], references: [id])
  answers    SimulacroAnswer[]

  @@map("simulacro_options")
}

model SimulacroAttempt {
  id                   String            @id @default(uuid())
  simulacroId          String            @map("simulacro_id")
  studentId            String            @map("student_id")
  startedAt            DateTime          @default(now()) @map("started_at")
  finishedAt           DateTime?         @map("finished_at")
  totalCorrect         Int               @default(0) @map("total_correct")
  totalAnswered        Int               @default(0) @map("total_answered")
  scorePercentage      Float?            @map("score_percentage")
  tabSwitches          Int               @default(0) @map("tab_switches")
  timeSpentSeconds     Int?              @map("time_spent_seconds")
  reportByCompetency   Json?             @map("report_by_competency")
  isCompleted          Boolean           @default(false) @map("is_completed")

  simulacro            Simulacro         @relation(fields: [simulacroId], references: [id])
  student              User              @relation(fields: [studentId], references: [id])
  answers              SimulacroAnswer[]

  @@map("simulacro_attempts")
}

model SimulacroAnswer {
  attemptId        String            @map("attempt_id")
  questionId       String            @map("question_id")
  selectedOptionId String?           @map("selected_option_id")
  answeredAt       DateTime          @default(now()) @map("answered_at")
  timeSpentSeconds Int?              @map("time_spent_seconds")

  attempt          SimulacroAttempt  @relation(fields: [attemptId], references: [id])
  question         SimulacroQuestion @relation(fields: [questionId], references: [id])
  selectedOption   SimulacroOption?  @relation(fields: [selectedOptionId], references: [id])

  @@id([attemptId, questionId])
  @@map("simulacro_answers")
}

// ============ COMMUNICATION ============

model Announcement {
  id        String   @id @default(uuid())
  cohortId  String   @map("cohort_id")
  authorId  String   @map("author_id")
  title     String
  body      String
  isPinned  Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")

  cohort    Cohort   @relation(fields: [cohortId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])

  @@index([cohortId, createdAt])
  @@map("announcements")
}

model EmailLog {
  id          String      @id @default(uuid())
  recipientId String      @map("recipient_id")
  emailType   EmailType   @map("email_type")
  subject     String
  sentAt      DateTime    @default(now()) @map("sent_at")
  resendId    String?     @map("resend_id")
  status      EmailStatus @default(SENT)

  recipient   User        @relation(fields: [recipientId], references: [id])

  @@map("email_logs")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String
  p256dhKey String   @map("p256dh_key")
  authKey   String   @map("auth_key")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("push_subscriptions")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String           @map("user_id")
  senderId    String?          @map("sender_id")
  title       String
  body        String
  type        NotificationType
  templateKey String?          @map("template_key")
  isRead      Boolean          @default(false) @map("is_read")
  createdAt   DateTime         @default(now()) @map("created_at")

  user        User             @relation(fields: [userId], references: [id])
  sender      User?            @relation("SentNotifications", fields: [senderId], references: [id])

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ============ CERTIFICATES ============

model Certificate {
  id               String   @id @default(uuid())
  studentId        String   @map("student_id")
  cohortId         String   @map("cohort_id")
  issuedAt         DateTime @default(now()) @map("issued_at")
  certificateUrl   String?  @map("certificate_url")
  verificationCode String   @unique @map("verification_code")

  student          User     @relation(fields: [studentId], references: [id])
  cohort           Cohort   @relation(fields: [cohortId], references: [id])

  @@map("certificates")
}

// ============ MONTHLY EXAMS (SIMULACROS MENSUALES) ============

model MonthlyExam {
  id                   String           @id @default(uuid())
  number               Int              @unique
  title                String
  mode                 MonthlyExamMode  @default(WEEKLY)
  availableFrom        DateTime?        @map("available_from")
  availableUntil       DateTime?        @map("available_until")
  isActive             Boolean          @default(false) @map("is_active")
  requiredModuleNumber Int?             @map("required_module_number")
  isBaseline           Boolean          @default(false) @map("is_baseline")
  createdAt            DateTime         @default(now()) @map("created_at")

  sections        ExamSection[]
  attempts        MonthlyExamAttempt[]
  manualUnlocks   ManualUnlock[]
  cohortSchedules CohortExamSchedule[]

  @@map("monthly_exams")
}

model ManualUnlock {
  id           String      @id @default(uuid())
  studentId    String      @map("student_id")
  examId       String      @map("exam_id")
  unlockedById String      @map("unlocked_by_id")
  reason       String?
  createdAt    DateTime    @default(now()) @map("created_at")

  student      User        @relation("ManualUnlocks", fields: [studentId], references: [id])
  exam         MonthlyExam @relation(fields: [examId], references: [id])
  unlockedBy   User        @relation("UnlockedByMe", fields: [unlockedById], references: [id])

  @@unique([studentId, examId])
  @@map("manual_unlocks")
}

model ExamSection {
  id              String              @id @default(uuid())
  examId          String              @map("exam_id")
  sectionNumber   Int                 @map("section_number")
  moduleNumber    Int                 @map("module_number")
  title           String
  durationMinutes Int                 @map("duration_minutes")
  totalQuestions  Int                 @map("total_questions")
  isWriting       Boolean             @default(false) @map("is_writing")
  orderIndex      Int                 @map("order_index")

  exam            MonthlyExam         @relation(fields: [examId], references: [id])
  questions       ExamSectionQuestion[]
  sectionAttempts ExamSectionAttempt[]

  @@unique([examId, sectionNumber])
  @@map("exam_sections")
}

model ExamSectionQuestion {
  id            String             @id @default(uuid())
  sectionId     String             @map("section_id")
  questionOrder Int                @map("question_order")
  caseText      String?            @map("case_text")
  questionText  String             @map("question_text")
  explanation   String?
  competency    String?

  section        ExamSection        @relation(fields: [sectionId], references: [id])
  options        ExamSectionOption[]
  answers        ExamSectionAnswer[]
  answerEvents   ExamAnswerEvent[]
  questionViews  ExamQuestionView[]

  @@unique([sectionId, questionOrder])
  @@map("exam_section_questions")
}

model ExamSectionOption {
  id         String              @id @default(uuid())
  questionId String              @map("question_id")
  letter     String
  text       String
  isCorrect  Boolean             @default(false) @map("is_correct")

  question       ExamSectionQuestion @relation(fields: [questionId], references: [id])
  answers        ExamSectionAnswer[]
  selectedEvents ExamAnswerEvent[]   @relation("SelectedOptionEvents")
  previousEvents ExamAnswerEvent[]   @relation("PreviousOptionEvents")

  @@map("exam_section_options")
}

model MonthlyExamAttempt {
  id          String              @id @default(uuid())
  examId      String              @map("exam_id")
  studentId   String              @map("student_id")
  startedAt   DateTime            @default(now()) @map("started_at")
  isCompleted Boolean             @default(false) @map("is_completed")
  totalScore  Float?              @map("total_score")

  exam        MonthlyExam         @relation(fields: [examId], references: [id])
  student     User                @relation(fields: [studentId], references: [id])
  sectionAttempts ExamSectionAttempt[]

  @@unique([examId, studentId])
  @@map("monthly_exam_attempts")
}

model ExamSectionAttempt {
  id               String            @id @default(uuid())
  examAttemptId    String            @map("exam_attempt_id")
  sectionId        String            @map("section_id")
  status           ExamSectionStatus @default(NOT_STARTED)
  startedAt        DateTime?         @map("started_at")
  submittedAt      DateTime?         @map("submitted_at")
  timeSpentSeconds Int               @default(0) @map("time_spent_seconds")
  tabSwitches      Int               @default(0) @map("tab_switches")
  totalCorrect     Int               @default(0) @map("total_correct")
  writingContent     String?           @map("writing_content")
  writingWordCount   Int?              @map("writing_word_count")
  totalAnswerChanges Int               @default(0) @map("total_answer_changes")

  examAttempt      MonthlyExamAttempt @relation(fields: [examAttemptId], references: [id])
  section          ExamSection        @relation(fields: [sectionId], references: [id])
  answers          ExamSectionAnswer[]
  answerEvents     ExamAnswerEvent[]
  questionViews    ExamQuestionView[]

  @@unique([examAttemptId, sectionId])
  @@map("exam_section_attempts")
}

model ExamSectionAnswer {
  sectionAttemptId String              @map("section_attempt_id")
  questionId       String              @map("question_id")
  selectedOptionId String?             @map("selected_option_id")
  answeredAt       DateTime            @default(now()) @map("answered_at")

  sectionAttempt   ExamSectionAttempt  @relation(fields: [sectionAttemptId], references: [id])
  question         ExamSectionQuestion @relation(fields: [questionId], references: [id])
  selectedOption   ExamSectionOption?  @relation(fields: [selectedOptionId], references: [id])

  @@id([sectionAttemptId, questionId])
  @@map("exam_section_answers")
}

// ============ EXAM RESEARCH METRICS ============

model ExamAnswerEvent {
  id               String               @id @default(uuid())
  sectionAttemptId String               @map("section_attempt_id")
  questionId       String               @map("question_id")
  selectedOptionId String?              @map("selected_option_id")
  previousOptionId String?              @map("previous_option_id")
  eventType        ExamAnswerEventType  @map("event_type")
  isCorrect        Boolean              @default(false) @map("is_correct")
  timestamp        DateTime             @default(now())

  sectionAttempt   ExamSectionAttempt   @relation(fields: [sectionAttemptId], references: [id])
  question         ExamSectionQuestion  @relation(fields: [questionId], references: [id])
  selectedOption   ExamSectionOption?   @relation("SelectedOptionEvents", fields: [selectedOptionId], references: [id])
  previousOption   ExamSectionOption?   @relation("PreviousOptionEvents", fields: [previousOptionId], references: [id])

  @@index([sectionAttemptId])
  @@index([sectionAttemptId, questionId])
  @@map("exam_answer_events")
}

model ExamQuestionView {
  id               String              @id @default(uuid())
  sectionAttemptId String              @map("section_attempt_id")
  questionId       String              @map("question_id")
  viewedAt         DateTime            @map("viewed_at")
  leftAt           DateTime?           @map("left_at")
  durationSeconds  Int?                @map("duration_seconds")

  sectionAttempt   ExamSectionAttempt  @relation(fields: [sectionAttemptId], references: [id])
  question         ExamSectionQuestion @relation(fields: [questionId], references: [id])

  @@index([sectionAttemptId])
  @@map("exam_question_views")
}

// ============ COHORT EXAM SCHEDULING ============

model CohortExamSchedule {
  id            String      @id @default(uuid())
  cohortId      String      @map("cohort_id")
  examId        String      @map("exam_id")
  startDay      Int         @map("start_day")
  scheduledById String      @map("scheduled_by_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  cohort      Cohort      @relation(fields: [cohortId], references: [id])
  exam        MonthlyExam @relation(fields: [examId], references: [id])
  scheduledBy User        @relation("ScheduledExams", fields: [scheduledById], references: [id])

  @@unique([cohortId, examId])
  @@map("cohort_exam_schedules")
}
